const XLSX = require('xlsx');\nconst fs = require('fs');\nconst path = require('path');\nconst { ipcRenderer } = require('electron');\n\n// Export to Excel\nasync function exportToExcel() {\n    try {\n        if (guests.length === 0) {\n            showNotification('មិនមានទិន្នន័យដែលយកចេញទេ', 'warning');\n            return;\n        }\n\n        showLoading(true);\n\n        // Prepare data for Excel\n        const excelData = guests.map((guest, index) => ({\n            '#': index + 1,\n            'ឈ្មោះមេហ្មាន (Guest Name)': guest.name,\n            'លេខទូរស័ព្ទ (Phone)': guest.phone || '',\n            'កំណត់ចំណាំ (Note)': guest.note || '',\n            'ចំនួន (Amount)': guest.amount,\n            'រូបិយភ័ណ្ឌ (Currency)': guest.currency,\n            'ប្រភេទការបង់ (Payment Type)': guest.payment_type,\n            'កាលបរិច្ឆេទបន្ថែម (Created Date)': new Date(guest.created_at).toLocaleDateString('km-KH')\n        }));\n\n        // Add summary row\n        const summaryRow = {\n            '#': '',\n            'ឈ្មោះមេហ្មាន (Guest Name)': 'សរុប (TOTAL)',\n            'លេខទូរស័ព្ទ (Phone)': '',\n            'កំណត់ចំណាំ (Note)': `ជំនួនចំនះ: ${totals.total_guests}`,\n            'ចំនួន (Amount)': '',\n            'រូបិយភ័ណ្ឌ (Currency)': 'KHR: ' + totals.total_khr.toLocaleString(),\n            'ប្រភេទការបង់ (Payment Type)': 'USD: $' + totals.total_usd.toLocaleString(),\n            'កាលបរិច្ឆេទបន្ថែម (Created Date)': new Date().toLocaleDateString('km-KH')\n        };\n\n        excelData.push(summaryRow);\n\n        // Create workbook and worksheet\n        const workbook = XLSX.utils.book_new();\n        const worksheet = XLSX.utils.json_to_sheet(excelData);\n\n        // Set column widths\n        const colWidths = [\n            { wch: 5 },   // #\n            { wch: 25 },  // Name\n            { wch: 15 },  // Phone\n            { wch: 30 },  // Note\n            { wch: 15 },  // Amount\n            { wch: 12 },  // Currency\n            { wch: 15 },  // Payment Type\n            { wch: 18 }   // Date\n        ];\n        worksheet['!cols'] = colWidths;\n\n        // Add worksheet to workbook\n        XLSX.utils.book_append_sheet(workbook, worksheet, 'Wedding Guest List');\n\n        // Create filename\n        const fileName = `Wedding_Guest_List_${new Date().toISOString().split('T')[0]}.xlsx`;\n        const downloadsPath = require('os').homedir() + '/Downloads';\n        const filePath = path.join(downloadsPath, fileName);\n\n        try {\n            // Write the file to Downloads folder\n            XLSX.writeFile(workbook, filePath);\n            showNotification(`រក្សាទុក Excel បានជោគជ័យ: ${fileName}`);\n        } catch (writeError) {\n            // Fallback: write to current directory\n            const fallbackPath = path.join(process.cwd(), fileName);\n            XLSX.writeFile(workbook, fallbackPath);\n            showNotification(`រក្សាទុក Excel បានជោគជ័យ: ${fileName} (in app folder)`);\n        }\n\n    } catch (error) {\n        console.error('Error exporting to Excel:', error);\n        showNotification('Error exporting to Excel: ' + error.message, 'error');\n    } finally {\n        showLoading(false);\n    }\n}\n\n// Export to PDF (using print)\nasync function exportToPDF() {\n    try {\n        if (guests.length === 0) {\n            showNotification('មិនមានទិន្នន័យដែលយកចេញទេ', 'warning');\n            return;\n        }\n\n        showLoading(true);\n\n        // Generate HTML for PDF\n        const htmlContent = generatePDFHTML();\n\n        // Create a data URL with the HTML content\n        const dataURL = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);\n        \n        // Open the content in a new window for printing\n        const printWindow = window.open(dataURL, '_blank', 'width=1200,height=800');\n        \n        if (printWindow) {\n            printWindow.onload = function() {\n                setTimeout(() => {\n                    printWindow.print();\n                    showNotification('សូមប្រើ \"Print to PDF\" ពីបន្ទះ Print dialog');\n                }, 1000);\n            };\n        } else {\n            showNotification('មិនអាចបើក Print window បានទេ។ សូមប្រើ Print ធម្មតា។', 'error');\n            // Fallback to regular print\n            window.print();\n        }\n\n    } catch (error) {\n        console.error('Error exporting to PDF:', error);\n        showNotification('Error exporting to PDF: ' + error.message, 'error');\n    } finally {\n        showLoading(false);\n    }\n}\n\n// Generate HTML for PDF export\nfunction generatePDFHTML() {\n    const currentDate = new Date().toLocaleDateString('km-KH', {\n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric'\n    });\n\n    let guestRows = '';\n    guests.forEach((guest, index) => {\n        guestRows += `\n            <tr>\n                <td>${index + 1}</td>\n                <td>${escapeHtml(guest.name)}</td>\n                <td>${escapeHtml(guest.phone || '-')}</td>\n                <td>${escapeHtml(guest.note || '-')}</td>\n                <td class=\"${guest.currency === 'KHR' ? 'khr-amount' : 'usd-amount'}\">\n                    ${formatCurrency(guest.amount, guest.currency)}\n                </td>\n                <td>\n                    <span class=\"payment-badge ${guest.payment_type.toLowerCase()}\">\n                        ${guest.payment_type === 'CASH' ? 'ប្រាក់សតែង' : guest.payment_type}\n                    </span>\n                </td>\n            </tr>\n        `;\n    });\n\n    return `\n        <!DOCTYPE html>\n        <html lang=\"km\">\n        <head>\n            <meta charset=\"UTF-8\">\n            <title>Wedding Guest List - PDF Export</title>\n            <link href=\"https://fonts.googleapis.com/css2?family=Nokora:wght@300;400;700;900&display=swap\" rel=\"stylesheet\">\n            <style>\n                * {\n                    margin: 0;\n                    padding: 0;\n                    box-sizing: border-box;\n                }\n                \n                body {\n                    font-family: 'Nokora', sans-serif;\n                    font-size: 12px;\n                    line-height: 1.4;\n                    color: #333;\n                    padding: 20px;\n                }\n                \n                .header {\n                    text-align: center;\n                    margin-bottom: 30px;\n                    border-bottom: 2px solid #e91e63;\n                    padding-bottom: 20px;\n                }\n                \n                .header h1 {\n                    font-size: 24px;\n                    font-weight: 700;\n                    color: #e91e63;\n                    margin-bottom: 10px;\n                }\n                \n                .header p {\n                    font-size: 14px;\n                    color: #666;\n                    margin-bottom: 5px;\n                }\n                \n                .summary {\n                    display: grid;\n                    grid-template-columns: repeat(4, 1fr);\n                    gap: 20px;\n                    margin-bottom: 30px;\n                }\n                \n                .summary-card {\n                    background: #f8f9fa;\n                    padding: 15px;\n                    border-radius: 8px;\n                    border: 1px solid #e2e8f0;\n                    text-align: center;\n                }\n                \n                .summary-card h3 {\n                    font-size: 14px;\n                    margin-bottom: 5px;\n                    color: #666;\n                }\n                \n                .summary-card .value {\n                    font-size: 18px;\n                    font-weight: 700;\n                    color: #333;\n                }\n                \n                .khr-amount { color: #e53e3e; }\n                .usd-amount { color: #38a169; }\n                \n                table {\n                    width: 100%;\n                    border-collapse: collapse;\n                    margin-top: 20px;\n                    background: white;\n                    border: 1px solid #e2e8f0;\n                }\n                \n                th, td {\n                    padding: 12px 8px;\n                    text-align: left;\n                    border-bottom: 1px solid #e2e8f0;\n                    vertical-align: top;\n                }\n                \n                th {\n                    background: #f8f9fa;\n                    font-weight: 600;\n                    color: #333;\n                    border-bottom: 2px solid #e2e8f0;\n                }\n                \n                th small {\n                    display: block;\n                    font-weight: 400;\n                    color: #666;\n                    font-size: 10px;\n                    margin-top: 2px;\n                }\n                \n                tbody tr:nth-child(even) {\n                    background: #f8f9fa;\n                }\n                \n                .payment-badge {\n                    display: inline-block;\n                    padding: 4px 8px;\n                    border-radius: 12px;\n                    font-size: 10px;\n                    font-weight: 600;\n                    text-transform: uppercase;\n                    color: white;\n                }\n                \n                .payment-badge.cash { background: #805ad5; }\n                .payment-badge.aba { background: #0066cc; }\n                .payment-badge.ac { background: #ff6b35; }\n                \n                .footer {\n                    margin-top: 30px;\n                    padding-top: 20px;\n                    border-top: 1px solid #e2e8f0;\n                    text-align: center;\n                    font-size: 10px;\n                    color: #666;\n                }\n                \n                @media print {\n                    body { margin: 0; padding: 15px; }\n                    .summary { grid-template-columns: repeat(4, 1fr); }\n                }\n            </style>\n        </head>\n        <body>\n            <div class=\"header\">\n                <h1>ប្រព័ន្ធកត់ចំណងដៃ</h1>\n                <p>Wedding List Management System</p>\n                <p>កាលបរិច្ឆេទ: ${currentDate}</p>\n            </div>\n            \n            <div class=\"summary\">\n                <div class=\"summary-card\">\n                    <h3>ជំនួនមេហ្មាន</h3>\n                    <div class=\"value\">${totals.total_guests.toLocaleString()}</div>\n                </div>\n                <div class=\"summary-card\">\n                    <h3>ចំនួនរៀប</h3>\n                    <div class=\"value khr-amount\">${totals.total_khr.toLocaleString()} ៛</div>\n                </div>\n                <div class=\"summary-card\">\n                    <h3>ចំនួនដុល្លារ</h3>\n                    <div class=\"value usd-amount\">$${totals.total_usd.toLocaleString()}</div>\n                </div>\n                <div class=\"summary-card\">\n                    <h3>ក្រដាសប្រាក់</h3>\n                    <div class=\"value\">${(totals.total_khr + (totals.total_usd * 4100)).toLocaleString()} ៛</div>\n                </div>\n            </div>\n            \n            <table>\n                <thead>\n                    <tr>\n                        <th style=\"width: 40px;\">#</th>\n                        <th style=\"width: 150px;\">ឈ្មោះមេហ្មាន<br><small>Guest Name</small></th>\n                        <th style=\"width: 100px;\">លេខទូរស័ព្ទ<br><small>Phone</small></th>\n                        <th style=\"width: 150px;\">កំណត់ចំណាំ<br><small>Note</small></th>\n                        <th style=\"width: 100px;\">ចំនួន<br><small>Amount</small></th>\n                        <th style=\"width: 80px;\">ប្រភេទ<br><small>Payment</small></th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${guestRows}\n                </tbody>\n            </table>\n            \n            <div class=\"footer\">\n                <p>Generated on ${new Date().toLocaleString('km-KH')} | ប្រព័ន្ធកត់ចំណងដៃ Wedding List Management System</p>\n            </div>\n        </body>\n        </html>\n    `;\n}\n\n// Make functions available globally\nwindow.exportToExcel = exportToExcel;\nwindow.exportToPDF = exportToPDF;